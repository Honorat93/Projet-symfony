{% extends 'base.html.twig' %}

{% block title %}Gestion des Utilisateurs{% endblock %}

{% block stylesheets %}
<style>
    .main-wrapper {
        display: flex;
        min-height: 100vh;
        background-color: #f8f9fa;
    }

    .sidebar {
        width: 200px;
        background: #ffffff;
        padding: 20px;
        box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1);
        position: fixed;
        height: 100%;
    }

    .sidebar-logo {
        width: 120px;
        margin: 0 auto 30px;
        display: block;
    }

    .nav-button {
        width: 100%;
        margin-bottom: 10px;
        text-align: left;
        padding: 12px;
        border-radius: 8px;
        transition: all 0.3s ease;
    }

    .nav-button:hover {
        transform: translateX(5px);
        background-color: #e9ecef;
    }

    .main-content {
        margin-left: 200px;
        flex: 1;
        padding: 30px;
        background-color: #ffffff;
        min-height: 100vh;
    }

    .action-header {
        display: flex;
        justify-content: flex-end;
        gap: 15px;
        margin-bottom: 30px;
    }

    .user-table {
        background: white;
        border-radius: 10px;
        overflow: hidden;
        box-shadow: 0 2px 15px rgba(0, 0, 0, 0.05);
    }

    .user-table th {
        background-color: #f8f9fa;
        padding: 15px;
        font-weight: 600;
    }

    .user-table td {
        padding: 12px 15px;
        vertical-align: middle;
    }

    .modal-input-group {
        margin-bottom: 20px;
    }

    .modal-input-group label {
        display: block;
        margin-bottom: 8px;
        font-weight: 500;
    }

    @media (max-width: 768px) {
        .sidebar {
            width: 100%;
            position: relative;
            height: auto;
        }

        .main-content {
            margin-left: 0;
        }

        .action-header {
            flex-direction: column;
        }
    }

    .icon-sm {
        width: 1em;
        height: 1em;
        vertical-align: middle;
        margin-right: 5px;
    }
</style>
{% endblock %}

{% block body %}
    {{ include('gestion_user/create_user.html.twig', {form: createForm}) }}
    {% set showCreateModal = createForm.vars.submitted and not createForm.vars.valid %}


    <div id="modal-flags" data-show-create="{{ showCreateModal ? '1' : '0' }}"></div>
    <div class="main-wrapper">
        <div class="sidebar">
            <img src="{{ asset('images/logo.png') }}" alt="Logo" class="sidebar-logo">
            <div class="d-flex flex-column">
                <button class="btn btn-outline-secondary nav-button" onclick="window.location.href='{{ path('web_get_all_users') }}'">
                    {{ ux_icon('bi:people', { class: 'icon-sm' }) }} Liste des Utilisateurs
                </button>
                <button class="btn btn-outline-secondary nav-button" onclick="window.location.href='{{ path('quote_home') }}'">
                    {{ ux_icon('bi:file-earmark-text', { class: 'icon-sm' }) }} Gestion des Devis
                </button>
                <button class="btn btn-danger nav-button mt-4" onclick="window.location.href='{{ path('app_logout') }}'">
                    {{ ux_icon('bi:box-arrow-right', { class: 'icon-sm' }) }} Déconnexion
                </button>
            </div>
        </div>

        <div class="main-content">
            <div class="action-header">
                {% if is_granted('USER_MANAGE') %}
                    <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#createModal">
                        {{ ux_icon('bi:plus-circle', { class: 'icon-sm' }) }} Créer
                    </button>
                {% else %}
                    <div class="alert alert-warning">
                        {{ ux_icon('bi:exclamation-triangle', { class: 'icon-sm' }) }} Vous n'êtes pas autorisé à créer un utilisateur.
                    </div>
                {% endif %}
            </div>

            <h2 class="mb-4">{{ ux_icon('bi:bar-chart', { class: 'icon-sm' }) }} Liste des Utilisateurs</h2>

            <table class="table user-table">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Nom</th>
                        <th>Prénom</th>
                        <th>Email</th>
                        <th>Genre</th>
                        <th>RGPD</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for user in users %}
                        <tr>
                            <td>{{ user.id }}</td>
                            <td>{{ user.lastname }}</td>
                            <td>{{ user.firstname }}</td>
                            <td>{{ user.email }}</td>
                            <td>{{ user.genre }}</td>
                            <td>
                                {{ user.rgpd
                                    ? ux_icon('bi:check-circle', { class: 'icon-sm text-success' })
                                    : ux_icon('bi:x-circle', { class: 'icon-sm text-danger' })
                                }}
                            </td>
                            <td>
                                <a href="{{ path('web_get_user', { id: user.id }) }}" class="btn btn-sm btn-info">
                                    {{ ux_icon('bi:eye', { class: 'icon-sm' }) }} Voir
                                </a>

                                <a href="{{ path('web_update_user', { id: user.id }) }}" class="btn btn-sm btn-warning">
                                    {{ ux_icon('bi:pencil-square', { class: 'icon-sm' }) }} Modifier
                                </a>

                                <form method="POST" action="{{ path('web_suppress_user', { id: user.id }) }}" style="display:inline;">
                                    <input type="hidden" name="_token" value="{{ csrf_token('delete-user-' ~ user.id) }}">
                                    <button type="submit" class="btn btn-sm btn-danger" onclick="return confirm('Supprimer cet utilisateur ?');">
                                        {{ ux_icon('bi:trash', { class: 'icon-sm' }) }} Supprimer
                                    </button>
                                </form>
                            </td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
{% endblock %}

{% block javascripts %}
{{ parent() }}
<script>
    document.addEventListener('DOMContentLoaded', function () {
    const modalFlags = document.getElementById('modal-flags');
    if (modalFlags && modalFlags.dataset.showCreate === '1') {
        const createModal = new bootstrap.Modal(document.getElementById('createModal'));
        createModal.show();
    }

    const cancelBtn = document.getElementById('cancelCreateUserBtn');
    const form = document.getElementById('createForm');
    const modalEl = document.getElementById('createModal');
    let wasCancelled = false;

    if (cancelBtn && modalEl && form) {
        cancelBtn.addEventListener('click', function () {
            wasCancelled = true;
        });

        modalEl.addEventListener('hidden.bs.modal', function () {
            if (wasCancelled) {
                form.querySelectorAll('input').forEach(input => {
                    if (['text', 'email', 'password'].includes(input.type)) {
                        input.value = '';
                    } else if (input.type === 'checkbox') {
                        input.checked = false;
                    }
                    input.classList.remove('is-invalid');
                });

                form.querySelectorAll('select').forEach(select => {
                    select.selectedIndex = 0;
                    select.classList.remove('is-invalid');
                });

                form.querySelectorAll('.invalid-feedback').forEach(error => error.remove());

                wasCancelled = false;
            }
        });
    }
});
</script>
{% endblock %}
